**资源限制**

 尽管工程师可以在本地运行测试，但是大多数测试执行都是在分布式环境中进行的称为Forge的系统。 Forge允许工程师在数据中心运行其构建和测试，这样可以最大程度地提高并行度。在我们的规模上，运行工程师按需执行的所有测试以及CB流程的每一部分的资源开销都是巨大的。即使有足够的计算资源，Forge和TAP都受到资源的限制。要解决这些问题 约束条件下，从事TAP工作的工程师想出了一些聪明的方法来确定应该在哪个时间运行哪些测试，以确保验证给定改变所需的资源数量达到最小。 确定需要运行哪些测试的主要机制是对每个更改的下游依赖关系图的分析。 Google的分布式构建工具， Forge和Blaze，维护全局依赖图的近实时版本并使其可用于TAP。因此，TAP可以快速确定哪些测试是来自下游带来的更改，并运行最小设置以确保更改是安全的。 影响使用TAP的另一个因素是测试的运行速度。 TAP经常能够以更少的测试比进行更多的测试更快地进行更改。这种偏见鼓励工程师编写小而集中的更改。触发100个测试的更改与触发1,000个测试的更改之间的等待时间差异可能是忙碌的一天中的数十分钟。想要花费更少时间等待的工程师最终完成了较小的，有针对性的变更，这对每个人都是胜利。 



**CI案例研究：Google Takeout**

Google Takeout于2011年作为数据备份和可下载产品开始。 创始人率先提出了“数据解放”的思想，即无论用户走到哪里他们能够轻松地以可用的格式随身携带他们的数据。他们从通过一些Google产品整合Takeout开始，生成以下产品的档案文件： 用户的照片，联系人列表等，并可根据他们的要求进行下载。但是，Takeout 并没有长期保持在一个小规模，而是为广泛的平台和服务而发展 各种Google产品。就像我们将看到的那样，有效的CI对于保持任何大型 项目运行良好，但是在应用程序快速增长时尤为重要。 

**场景1：一直中断的dev部署** 

**问题：**随着Takeout因其强大的Google范围内的数据提取、存档和下载功能而享有盛誉，该公司的其他团队开始使用它， 请求API以便它们自己的应用程序可以提供备份和下载 功能，包括Google云端硬盘（文件夹下载由Takeout提供） 和Gmail（用于ZIP文件预览）。总而言之，Takeout从成为后端只是原始的Google Takeout产品，变成可为至少10个其他Google提供API 的产品，并提供广泛的功能。小组决定使用以下方法将每个新API部署为自定义实例： 相同的原始Takeout二进制文件，但配置它们的工作方式略有不同。例如，云端硬盘批量下载的环境拥有最大的机队，最多的预留配额，用于从Drive API提取文件以及一些自定义身份验证，允许非登录用户下载公用文件夹的逻辑。 不久之后，Takeout就面临“标志问题”。为其中一个实例添加的标志将破坏其他服务器，并且当服务器无法启动时，它们的部署也将由于配置不兼容中断。除了功能配置外，还有安全性和ACL配置。例如，消费者云端硬盘下载服务不应获取用于加密企业Gmail导出的密钥。配置很快变得复杂，并导致几乎每夜被破坏。 已进行了一些工作来整理和模块化配置，但暴露出的更大问题是，当外卖工程师想要编写代码时 更改，在每个配置下手动测试每个服务器是否在每个服务器下启动是不切实际的。他们直到第二天部署时才发现有关配置失败的信息。在提交前和提交后（由TAP）进行了单元测试，但是 这些还不足以解决这类问题。 

**团队做了什么。**团队为以下项目创建了临时的沙盒迷你环境，在预先提交的情况下运行的每个实例均已测试所有服务器是否运行正常。在提交前运行临时环境阻止了95％的 错误的配置导致的服务器损坏，并减少了50%夜间部署故障。 尽管这些新的沙盒提交前测试大大减少了部署失败，但并没有完全消除它们。特别是Takeout的端到端测试仍然会经常破坏部署，并且这些测试很难在提交前进行 （因为他们使用测试帐户，在某些情况下仍然像真实帐户一样并受到相同的安全性和隐私权保护。重新设计要预先提交友好信息，这将是一项艰巨的任务。如果团队无法在提交前进行端到端测试，什么时候可以运行它们？它希望比第二天的开发人员部署更快地获得端到端的测试结果， 决定每两个小时是一个很好的开始。但是团队不想太频繁地做完整的dev部署，这会产生开销并中断长时间运行的工程师们正在测试的dev流程。为创建新的共享测试环境的这些测试似乎也为配置资源提供了过多的开销，另外还有罪魁祸首----查找（即查找导致失败的部署）可能涉及一些不合意手动操作。 因此，团队重用了预先提交的沙盒环境，从而轻松扩展并将他们转移到新的提交后环境中。与提交前不同，提交后符合安全保障，可以使用测试帐户（其中一个原因是代码被批准），因此可以在此处运行端到端测试。提交后CI每运行两个小时，从green head获取最新的代码和配置，创建 RC，并针对已在dev中运行的RC运行相同的端到端测试套件。

 **经验教训。**更快的反馈循环可防止开发人员部署出现问题： •将各种Takeout的测试从“每晚部署后”转移到预先提交，这防止了95％损坏的服务器因配置错误并减少50%每晚部署失败的次数。 尽管端对端测试无法一路走到预先提交的状态，但它们却是仍然从“每晚部署后”更改为“两个小时内提交后”。这有效地将“罪魁祸首”削减了12倍。 

**场景2：难以理解的测试日志** 

**问题：**随着Takeout集成了更多Google产品，它发展成为一个允许产品团队插入插件的成熟平台，并使用特定于产品的数据获取直接导入到Takeout的二进制文件中的代码。例如，Google Photos插件知道如何获取照片，相册元数据等。Takeout从其扩展原始的“少量”产品现在可以与90多个产品集成。 Takeout的端到端测试将其故障转储到日志中，但这种方法无法扩展 到90个产品插件。随着更多产品的集成出现了更多的故障。 即使团队早些时候运行测试，并且增加了更多的提交后CI的数量，多个故障仍然会堆积在内部，并且很容易丢失。通过这些日志带来令人沮丧的时间消耗，并且测试是几乎总是失败。 

**团队做了什么。**团队将测试重构为动态的，基于配置的套件（使用参数化的测试运行程序）可在更友好的用户界面中报告结果， 清楚地将单个测试结果显示为绿色或红色：不需再浏览日志。 通过显示故障，它们还使故障的调试更加容易，错误消息中直接包含信息以及指向日志的链接。例如，如果Takeout无法从Gmail提取文件，则该测试将动态构建一个链接，该链接可以在“导出”日志中搜索该文件的ID，并将其包含在测试失败消息中。 这可以自动完成产品插件工程师和工程师的大部分调试过程。 如图23-3所展示的，需要Takeout在发送日志时所需的帮助更少。

 **经验教训。**来自CI的可访问，可行的反馈减少了测试失败，并且提高生产力。这些举措减少了Takeout团队的参与调试客户端（产品插件）测试失败的可能性，达到了35％。

 **场景3：调试“所有Google” **

 **问题：**团队未预料到的Takeout CI有趣的副作用，就是因为它验证了90种以存档的形式面向最终用户的奇怪产品的输出，他们基本上是在测试“所有Google”并发现问题与Takeout无关。这是一件好事----Takeout能够帮助提高Google产品的整体质量。但是，这引入了他们的CI流程存在一个问题：他们需要更好的故障隔离，以便他们可以确定在他们的构建中的问题（哪些是少数）以及在它们所调用的产品API后面放置松散耦合的微服务的问题。 

**团队做了什么。**团队的解决方案是连续运行完全相同的测试套件，就像在提交后CI中所做的那样反生产。这实施起来很便宜并允许团队隔离哪些故障是其构建和生产中的新问题，例如，某个地方的微服务发布的结果“在Google中”的其他地方。

**经验教训。**针对prod和提交后的CI运行相同的测试套件（带有新建的二进制文件，但后端具有相同的实时后端）是隔离故障的廉价方法。 

**仍然存在的挑战。**展望未来，测试“ Google全部”的负担（显然， 这是夸大其词，因为大多数产品问题都是由各自的团队引起）随着Takeout与更多产品的集成以及这些产品变得更加复杂。进行CI和prod之间的人工比较会使得Build Cop的时间开销会比较大。 

**未来的改进。**Takeout提交后的CI中可以进行记录/重播，这为尝试密封测试提供了一个有趣的机会。从理论上讲，这将消除来自Takeout的CI中显示的后端产品API的失败，这将使套件在Takeout的最后两个小时内更稳定，更有效地捕获故障，这种变化是其预期的目的。 

**场景4：保持绿色**

 **问题：**由于平台支持更多产品插件，每个插件都包含端到端测试，这些测试将失败，并且端到端测试套件几乎总是坏的。这些故障无法立即全部解决。许多是由于产品插件二进制文件中的错误，这是Takeout团队无法控制的错误。有些失败比其他失败更重要----低优先级的错误和测试中的错误，它们不需要阻塞发布，而更高优先级的错误需要阻塞发布。团队可以通过注释掉测试来轻松禁用测试，但这会导致失败太容易被忘记。 一种常见的故障源：产品插件滚动时测试会中断出一个特性。例如，YouTube插件的播放列表获取功能 可能需要先在dev中启用几个月的测试功能，然后才能prod中启用该功能。 Takeout测试只知道要检查的一个结果，因此通常会导致需要在特定环境中禁用该测试，并手动将其设置为推出特性。 

**团队做了什么。**团队提出了一种策略来通过以下方式禁用失败的测试： 用相关的bug标记它们，并将其提交给负责的团队（通常是产品插件小组）。如果测试失败并带有错误标记，则团队的测试框架将抑制其失败。如图23-4所示，这使测试套件保持绿色并让我们确信，除了已知问题之外，其他所有事情都已经解决。

对于推出问题，该团队增加了功能，供插件工程师指定启用特定功能的功能标志的名称或代码更改的ID以及带有和不带有该功能的输出。测试是可以查询测试环境以确定给定功能是否为在那里启用并相应地验证了预期的输出。 当来自禁用测试的错误代码开始累积且未更新时， 团队自动化了清理工作。测试通过查询我们的错误系统的API来检查是否已关闭bug。如果标记失败的测试确定通过并且通过时间超过配置的时间限制，测试将提示清理标记（如果尚未修复，请标记该错误）。有一个例外策略：片状测试。对于这些，团队将允许将测试标记为片状，并且如果通过，系统将不会提示标记为“片状”的清除失败。 如图23-5所示，这些更改使得测试套件几乎可以自我维护。 

**汲取的经验教训。**禁用无法立即修复的失败测试是一个很实际的，保持套件绿色的方法，这使您确信自己了解所有情况下的测试失败。此外，自动化测试套件的维护，包括部署管理并更新固定测试的跟踪错误，以保持套件的清洁并防止技术债务累积。用DevOps的话来说，我们可以在图23-5 MTTCU中称该指标： 平均清理时间。 

**未来的改进。**自动化错误的归档和标记将很有帮助的下一个步骤。这仍然是一个手动且繁琐的过程。如前所述，一些我们较大的团队已经做到了这一点。 

**其他挑战。**面对Takeout，我们描述的场景远非唯一的CI挑战 ，仍然有更多问题需要解决。例如，我们在490页提到 在“ CI挑战”中从上游服务中隔离故障的难度 。这是一个问题，Takeout在使用上游服务时仍然面临着罕见的破损，例如流式基础结构中的安全更新时 Takeout的“驱动器文件夹下载” API使用的API在以下情况下破坏了存档解密： 它部署到生产中。上游服务本身是分阶段进行和测试的， 但是没有简单的方法可以自动检查CI是否与CI兼容将它们投入生产后于Takeout相适应。最初的解决方案涉及创建一个“上游暂存” CI环境，但这会带来其测试生产Takeout二进制文件与他们上游依赖项的暂存版本相冲突。但是，事实证明这很难维护，以及过渡和生产版本之间的其他兼容性问题。 

**但我无法负担CI ** 您可能会认为这很好，但是您既没有时间也没有钱来建造这一切。我们当然承认Google可能还有更多资源，以比典型的初创公司更有效地实施CI。但是我们的许多产品增长如此之快，以至于他们也没有时间开发CI系统（至少不是足够的时间）。 在您自己的产品和组织中，尝试考虑一下您已经付出的成本 支付在生产中发现并处理的问题的费用。这些负面影响终端用户或客户，当然，但它们也会影响团队。频繁生产导致救火的压力很大，这是令人沮丧的。尽管建立CI系统是价格昂贵，不一定是那些左移至较早的新费用，更可取的是，它减少了阶段的发生率，从而使降低问题的成本发生在右侧。 CI带来了更稳定的产品并使开发人员感到轻松。在这种文化中，工程师更加自信“系统”会发现问题， 他们可以将更多的精力放在功能上，而不是在修复上。 

**结论** 即使我们已经描述了CI流程以及我们实现自动化的一些方式，这并不是说我们已经开发了完善的CI系统。毕竟，CI 系统本身只是软件，永远不会完善，应进行调整以满足以下要求： 旨在满足应用程序和工程师不断发展的需求。我们试图用Takeout CI的演变和未来的改进领域来说明这一点。 

**TL; DR**  •CI系统决定使用什么测试以及何时使用。 随着您的代码库的老化和规模的增长，CI系统变得越来越必要。 •CI应该优化预先提交上的更快，更可靠的测试，以及在提交后上更慢，更短的测试。 可获得的，可行的反馈能使CI系统变得更加高效。 

